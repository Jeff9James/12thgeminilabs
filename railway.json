{
  "$schema": "https://railway.com/railway.schema.json",
  "_comments": {
    "variables": [
      "IMPORTANT: Railway's Shared Variables DO NOT automatically inherit to services!",
      "",
      "To fix 'npm error code 1' crashes due to missing environment variables:",
      "",
      "1. Create Shared Variables in Project Settings → Shared Variables",
      "2. CRITICAL: Explicitly share them with your backend service!",
      "   - Click 'Share' button on each variable",
      "   - Select the backend service",
      "   OR navigate to backend service → Variables → Shared Variable → Add all",
      "",
      "Required Environment Variables:",
      "  - GEMINI_API_KEY (get from https://makersuite.google.com/app/apikey)",
      "  - GOOGLE_CLIENT_ID (OAuth credentials from Google Cloud Console)",
      "  - GOOGLE_CLIENT_SECRET (OAuth credentials from Google Cloud Console)",
      "  - JWT_SECRET (generate with: openssl rand -base64 32)",
      "  - JWT_REFRESH_SECRET (generate with: openssl rand -base64 32)",
      "  - NODE_ENV=production",
      "  - PORT=3001 (or Railway's auto-assigned port)",
      "  - DATABASE_PATH=/data/database.db (requires persistent volume)",
      "  - VIDEO_STORAGE_PATH=/data/videos (requires persistent volume)",
      "  - VIDEO_STORAGE_TYPE=local (or 'firebase')",
      "  - FRONTEND_URL=https://your-frontend-domain.com",
      "  - LOG_LEVEL=info (optional: debug, info, warn, error)",
      "",
      "See RAILWAY_SETUP.md for detailed step-by-step instructions",
      "",
      "Variable Inheritance:",
      "  - Service Variables: Scoped to one service only",
      "  - Shared Variables: Project-wide but MUST be explicitly shared",
      "  - Reference Variables: Use template syntax ${{shared.VAR_NAME}}",
      "  - Railway-Provided: Automatic (RAILWAY_PUBLIC_DOMAIN, etc.)",
      "",
      "Persistent Volume Required:",
      "  1. Go to backend service → Settings → Volumes",
      "  2. Create volume: Name='data', Mount='/data', Size=1GB+",
      "  3. Railway auto-redeploys with volume attached",
      "",
      "Health Check Configuration:",
      "  - healthcheckTimeout: 30000 (30 seconds) - Increased from 100ms to prevent SIGTERM crashes",
      "  - Server needs time to: validate env → connect to DB → run migrations → start → respond to health check",
      "  - Typical startup time on Railway: 2-5 seconds with slower I/O",
      "  - SIGTERM crash loop symptom indicates health check timing out before server is ready"
    ]
  },
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "npm install --legacy-peer-deps && npm run build:shared && npm run build:backend",
    "watchPatterns": ["backend/**", "shared/**"],
    "nixpacksPlan": {
      "phases": {
        "install": {
          "cmds": ["npm install --legacy-peer-deps"]
        }
      }
    }
  },
  "deploy": {
    "startCommand": "cd backend && npm start",
    "healthcheckPath": "/api/health",
    "healthcheckTimeout": 30000,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
